<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengeluaran Mudah</title>
    <!-- 
        CATATAN: CDN Tailwind CSS digunakan untuk pengembangan cepat di satu file. 
        Untuk lingkungan produksi, disarankan menggunakan instalasi penuh Tailwind.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tambahkan Chart.js untuk Visualisasi Data -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script> 
    <style>
        /* Gaya Kustom untuk Keindahan dan Responsivitas */
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; }
        h1 { color: #1e3a8a; border-bottom: 2px solid #bfdbfe; padding-bottom: 5px; }
        
        /* Gaya Item Pengeluaran */
        .expense-item { 
            border-bottom: 1px solid #e5e7eb; 
            padding: 1rem 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .amount { 
            font-weight: bold; 
            color: #ef4444; /* Warna merah untuk pengeluaran */
            font-size: 1.1em;
            text-align: right;
        }
        .auth-card, .app-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        /* Mengatasi batasan penggunaan alert/confirm */
        .info-message {
            background-color: #fef3c7;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #fde68a;
        }
    </style>
    
    <!-- SDK Firebase Kompatibilitas Layer -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> 

</head>
<body class="bg-gray-50 p-4">

<div class="container">
    <h1 class="text-3xl font-bold mb-6 text-center">üí∞ Catat Pengeluaran Harian</h1>

    <!-- BAGIAN 1: INPUT NAMA PENGGUNA (Ganti Otentikasi) -->
    <div id="auth-section" class="auth-card">
        <h2 class="text-xl font-semibold mb-4 text-blue-700">Mulai Catat Pengeluaran</h2>
        <p class="text-sm text-gray-600 mb-4">Aplikasi ini menggunakan login anonim otomatis.</p>
        
        <!-- Input Nama Pengguna -->
        <input type="text" id="user-name-input" placeholder="Masukkan Nama Anda" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        
        <div class="flex">
            <button id="start-button" onclick="startAppAsUser()" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-150">Mulai</button>
        </div>
        <div id="auth-error" class="mt-4 text-red-600 text-sm font-medium"></div>
    </div>
    
    <!-- BAGIAN 2: APLIKASI UTAMA (TIDAK TERLIHAT SEBELUM LOGIN) -->
    <div id="main-app" class="app-card" style="display: none;">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-700">Halo, <span id="user-display-name" class="font-bold text-blue-700">Pengguna</span>!</h3>
            <button onclick="signOut()" class="p-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold text-sm rounded-lg transition duration-150">Keluar</button>
        </div>
        
        <!-- Formulir Pengeluaran -->
        <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">üìù Catat Pengeluaran</h2>
        <form id="expense-form" class="space-y-3">
            <input type="number" id="amount" placeholder="Jumlah (contoh: 50000)" required class="w-full p-3 border border-gray-300 rounded-lg">
            <input type="text" id="description" placeholder="Deskripsi (contoh: Kopi dan Roti)" required class="w-full p-3 border border-gray-300 rounded-lg">
            <select id="category" required class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                <option value="" disabled selected>Pilih Kategori</option>
                <option value="Makanan">Makanan</option>
                <option value="Transportasi">Transportasi</option>
                <option value="Belanja">Belanja</option>
                <option value="Hiburan">Hiburan</option>
                <option value="Lainnya">Lainnya</option>
            </select>
            <button type="submit" class="w-full p-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-150">Tambah Pengeluaran</button>
        </form>
        
        <hr class="my-6">
        
        <!-- Ringkasan -->
        <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">üìä Ringkasan Total</h2>
        <p class="text-gray-700 text-lg">Total Pengeluaran: <span id="total-amount" class="font-bold text-red-600 ml-2">Rp 0</span></p>

        <hr class="my-6">

        <!-- Bagian Rekap Bulanan dan Chart -->
        <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">üìà Grafik Pengeluaran Bulanan</h2>
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <canvas id="monthlyChart"></canvas>
        </div>

        <hr class="my-6">
        
        <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">üìÖ Rekap Pengeluaran per Bulan</h2>
        <div id="monthly-recap" class="mt-4">
            <!-- Tabel rekap bulanan akan dimuat di sini -->
            <p class="text-gray-500">Memuat data rekap...</p>
        </div>
        
        <hr class="my-6">
        
        <!-- Riwayat Transaksi -->
        <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">üìú Riwayat Transaksi</h2>
        <div class="info-message">
            Untuk **Edit** atau **Hapus**, tombol akan menampilkan instruksi di *Console* (F12) karena batasan keamanan di lingkungan ini. Anda perlu mengetik perintah `manualEdit()` atau `manualDelete()` di sana.
        </div>
        <div id="expense-list" class="mt-4">
            <!-- Data akan dimuat di sini oleh script.js -->
        </div>
    </div>
</div>
    
<script>
// ------------------------------------
// BAGIAN 1: KONFIGURASI, INISIALISASI, DAN CAKUPAN GLOBAL
// ------------------------------------
let db = null;
let auth = null;
let currentUserId = null;
let currentUserName = null; // Menyimpan nama pengguna

// Variabel baru untuk Chart dan Recap
let chartInstance = null; // Untuk menyimpan instance Chart.js

let userNameInput, startButton, authError, authSection, mainApp, userDisplayNameSpan;
let expenseForm, amountInput, descriptionInput, categoryInput, expenseList, totalAmountSpan;
let monthlyChartCanvas, monthlyRecapDiv;

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Pastikan firebaseConfig adalah objek
let firebaseConfig = {};
try {
    const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    if (configString.trim() !== '') {
        firebaseConfig = JSON.parse(configString);
    }
} catch (e) {
    console.error("[FATAL ERROR] Gagal parsing __firebase_config. Konfigurasi diatur ke kosong.", e);
}


// ------------------------------------
// SELURUH LOGIKA APLIKASI DIJALANKAN SETELAH DOM SIAP
// ------------------------------------
window.onload = function() {
    // 1. DOM Elements
    userNameInput = document.getElementById('user-name-input');
    startButton = document.getElementById('start-button');
    authError = document.getElementById('auth-error');
    authSection = document.getElementById('auth-section');
    mainApp = document.getElementById('main-app');
    userDisplayNameSpan = document.getElementById('user-display-name');
    expenseForm = document.getElementById('expense-form');
    amountInput = document.getElementById('amount');
    descriptionInput = document.getElementById('description');
    categoryInput = document.getElementById('category');
    expenseList = document.getElementById('expense-list');
    totalAmountSpan = document.getElementById('total-amount');
    monthlyChartCanvas = document.getElementById('monthlyChart');
    monthlyRecapDiv = document.getElementById('monthly-recap');


    // 2. INISIALISASI FIREBASE (MODE PERMANEN)
    if (!firebaseConfig.projectId) {
        console.warn("[WARNING FIREBASE] Konfigurasi Firebase (Project ID) TIDAK ADA. Aplikasi MUNGKIN gagal terhubung ke database. Cek konfigurasi.");
    }

    // Inisialisasi Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    db = firebase.firestore();
    auth = firebase.auth();
    
    firebase.firestore.setLogLevel('debug');
    console.log("[DEBUG FIREBASE] Firebase berhasil diinisialisasi dan objek db/auth tersedia.");
    
    // 3. START LISTENERS DAN AUTHENTIKASI
    setupAuthListener();
};


// ------------------------------------
// BAGIAN 2: FUNGSI OTENTIKASI BARU (ANONIM & NAMA PENGGUNA)
// ------------------------------------

function signOut() {
    if (auth) {
        // Hapus nama pengguna saat logout
        sessionStorage.removeItem('currentUserName');
        auth.signOut();
        console.log("[DEBUG AUTH] Pengguna mencoba Keluar.");
    }
}

// Menghubungkan fungsi ke window agar dapat dipanggil dari onclick
window.signOut = signOut;

// Fungsi untuk menangani klik tombol "Mulai"
function startAppAsUser() {
    const name = userNameInput.value.trim();
    if (name) {
        currentUserName = name;
        sessionStorage.setItem('currentUserName', name);
        // Pindah ke tampilan utama
        authSection.style.display = 'none';
        mainApp.style.display = 'block';
        userDisplayNameSpan.textContent = currentUserName;
        // Panggil kembali listener untuk memuat data (jika auth sudah selesai)
        if (currentUserId) {
            loadExpenses();
        }
    } else {
        authError.textContent = 'Nama Pengguna harus diisi untuk memulai.';
    }
}
window.startAppAsUser = startAppAsUser;

// ------------------------------------
// BAGIAN 3: LISTENER PERUBAHAN STATUS OTENTIKASI
// ------------------------------------

// Fungsi untuk menangani otentikasi awal (Selalu Anonim)
async function initialAuth() {
    if (!auth) return;
    
    try {
        // Selalu coba sign in anonim jika belum ada user
        if (!auth.currentUser) {
            await auth.signInAnonymously();
            console.log("[DEBUG AUTH] Sign-in Anonim berhasil.");
        }
    } catch (error) {
        console.error("Gagal melakukan sign-in Anonim:", error);
        authError.textContent = `Gagal inisialisasi otentikasi. Cek konsol.`;
    }
}

// Menyiapkan Listener Otentikasi
function setupAuthListener() {
    if (!auth) {
        console.error("[AUTH ERROR] setupAuthListener dibatalkan: Objek 'auth' tidak ada.");
        return;
    }
    
    // Otentikasi awal (dilakukan segera di mode anonim)
    initialAuth();
    
    auth.onAuthStateChanged((user) => {
        if (user) {
            // Pengguna berhasil login/masuk (Anonim)
            currentUserId = user.uid;
            console.log(`[DEBUG AUTH] Status: LOGIN. UID: ${currentUserId}, Email: ${user.email || 'Anonim'}`);
            
            // Cek nama pengguna
            currentUserName = sessionStorage.getItem('currentUserName');

            if (currentUserName) {
                // NAMA ADA: Tampilkan aplikasi utama
                authSection.style.display = 'none';
                mainApp.style.display = 'block';
                userDisplayNameSpan.textContent = currentUserName; 
                
                // Setelah login, siapkan form submit dan muat data
                setupExpenseFormListener();
                loadExpenses();

            } else {
                // NAMA BELUM ADA: Tampilkan bagian input nama
                authSection.style.display = 'block';
                mainApp.style.display = 'none';
            }
            
            authError.textContent = '';
            
        } else {
            // Pengguna logout
            console.log("[DEBUG AUTH] Status: LOGOUT.");
            currentUserId = null;
            currentUserName = null;
            
            if (authSection && mainApp) {
                authSection.style.display = 'block';
                mainApp.style.display = 'none';
                // Reset input nama pengguna
                userNameInput.value = '';
            }

            // Bersihkan tampilan saat logout
            if (expenseList && totalAmountSpan) {
                expenseList.innerHTML = '';
                totalAmountSpan.textContent = `Rp 0`;
                // Bersihkan tampilan chart dan rekap
                if (chartInstance) chartInstance.destroy();
                if (monthlyRecapDiv) monthlyRecapDiv.innerHTML = '<p class="text-gray-500">Memuat data rekap...</p>';
            }
        }
    });
}

// ------------------------------------
// BAGIAN 4: FUNGSI PENGELUARAN (CRUD)
// ------------------------------------

// Fungsi 4A: CREATE (Menambahkan Pengeluaran)
function setupExpenseFormListener() {
    if (expenseForm) {
        expenseForm.removeEventListener('submit', handleExpenseSubmit); 
        expenseForm.addEventListener('submit', handleExpenseSubmit); 
    }
}

async function handleExpenseSubmit(e) {
    e.preventDefault();

    if (!currentUserId || !db || !currentUserName) {
        authError.textContent = 'Layanan tidak tersedia. Silakan masuk (login) terlebih dahulu dan isi Nama Pengguna.';
        return console.error("[DEBUG DATA] Gagal menambah. Tidak ada user, DB, atau Nama Pengguna tidak terinisialisasi.");
    }

    const amount = parseInt(amountInput.value);
    const category = categoryInput.value;
    const description = descriptionInput.value;
    // Menggunakan format YYYY-MM-DD untuk kemudahan sorting/grouping
    const date = new Date().toISOString().split('T')[0];
    
    // Path Koleksi Private Firestore
    const collectionPath = `/artifacts/${appId}/users/${currentUserId}/expenses`;
    const userExpensesCollection = db.collection(collectionPath);
    console.log(`[DEBUG DATA] Mencoba menambah data ke path: ${collectionPath}`);


    if (amount > 0 && category && description) {
        try {
            await userExpensesCollection.add({
                amount: amount,
                category: category,
                description: description,
                date: date,
                // Menggunakan timestamp Firestore yang asli
                timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
                userId: currentUserId,
                userName: currentUserName 
            });
            console.log("[DEBUG DATA] Transaksi berhasil ditambahkan!");
            expenseForm.reset(); 
        } catch (error) {
            console.error("[DEBUG DATA] Error saat menambahkan dokumen: ", error);
            authError.textContent = 'Gagal menambah transaksi. Kemungkinan masalah Izin (Security Rules). Cek konsol.';
        }
    } else {
        console.log("[DEBUG DATA] Peringatan: Pastikan semua kolom terisi dengan benar.");
    }
}

// Fungsi 4B: READ (Memuat dan Menampilkan Pengeluaran)
function loadExpenses() {
    if (!currentUserId || !expenseList || !totalAmountSpan || !db || !currentUserName) {
        return console.log("[DEBUG DATA] loadExpenses dihentikan. Pre-requisite tidak terpenuhi.");
    }
    
    const collectionPath = `/artifacts/${appId}/users/${currentUserId}/expenses`;
    const userExpensesCollection = db.collection(collectionPath);
    console.log(`[DEBUG DATA] Menyiapkan listener data dari path: ${collectionPath}`);

    // Menggunakan onSnapshot untuk pembaruan real-time
    userExpensesCollection
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
            console.log(`[DEBUG DATA] Snapshot diterima. Jumlah dokumen: ${snapshot.size}`);
            expenseList.innerHTML = '';
            let total = 0;
            let rawData = []; // Array untuk menyimpan data mentah

            snapshot.forEach(doc => {
                const data = doc.data();
                const itemAmount = typeof data.amount === 'number' ? data.amount : 0;
                total += itemAmount;
                rawData.push({ ...data, id: doc.id }); // Simpan data mentah

                const docId = doc.id; 
                
                const item = document.createElement('div');
                item.className = 'expense-item';
                
                // Struktur HTML item pengeluaran
                item.innerHTML = `
                    <div style="flex-grow: 1;">
                        <strong class="text-gray-900">${data.description}</strong> 
                        <span class="text-sm text-gray-500">(${data.category}) - ${data.date}</span>
                    </div>
                    <div class="amount">Rp ${itemAmount.toLocaleString('id-ID')}</div>
                    <div class="flex space-x-2">
                        <!-- Tombol Edit -->
                        <button onclick="window.handleEditClick('${docId}', ${itemAmount}, '${data.category}', '${data.description}')" 
                                class="p-2 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition duration-150">
                            Edit
                        </button>
                        
                        <!-- Tombol Hapus -->
                        <button onclick="window.handleDeleteClick('${docId}')" 
                                class="p-2 bg-red-500 hover:bg-red-600 text-white text-xs rounded transition duration-150">
                            Hapus
                        </button>
                    </div>
                `;
                
                expenseList.appendChild(item);
            });
            
            totalAmountSpan.textContent = `Rp ${total.toLocaleString('id-ID')}`;

            // Panggil fungsi baru untuk memproses dan menampilkan chart/rekap
            renderChartsAndSummary(rawData);
            
        }, error => {
            console.error("[DEBUG DATA] Error saat membaca data (onSnapshot): ", error);
            authError.textContent = 'Gagal memuat data. Kemungkinan masalah Izin (Security Rules). Cek konsol.';
        });

}

// ------------------------------------
// BAGIAN 5: VISUALISASI DAN REKAP BULANAN
// ------------------------------------

function renderChartsAndSummary(data) {
    if (!monthlyChartCanvas || !monthlyRecapDiv) return;

    // 1. Agregasi Data per Bulan
    const monthlySummary = data.reduce((acc, expense) => {
        // Tanggal tersimpan sebagai 'YYYY-MM-DD'
        const yearMonth = expense.date ? expense.date.substring(0, 7) : 'Unknown'; 
        acc[yearMonth] = (acc[yearMonth] || 0) + expense.amount;
        return acc;
    }, {});
    
    // Konversi objek ke array terurut (berdasarkan tahun-bulan, yang terbaru di atas)
    const sortedMonths = Object.keys(monthlySummary).sort().reverse();
    
    const chartLabels = [];
    const chartData = [];
    
    // Siapkan HTML untuk tabel rekap
    let recapHTML = `
        <div class="overflow-x-auto rounded-lg shadow-md">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-100">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider">Bulan</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-blue-800 uppercase tracking-wider">Total Pengeluaran</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;

    if (sortedMonths.length === 0) {
        recapHTML += `
            <tr>
                <td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">Belum ada data pengeluaran.</td>
            </tr>
        `;
    }
    
    sortedMonths.forEach(ym => {
        const amount = monthlySummary[ym];
        // Format bulan: cth. "Desember 2025"
        const displayMonth = new Date(ym + '-01').toLocaleString('id-ID', { year: 'numeric', month: 'long' });
        
        // Data untuk Chart (urutannya perlu dibalik untuk chart yang logis/dari waktu ke waktu)
        chartLabels.unshift(displayMonth);
        chartData.unshift(amount);
        
        // Data untuk Tabel Recap
        recapHTML += `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${displayMonth}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600 font-bold">Rp ${amount.toLocaleString('id-ID')}</td>
            </tr>
        `;
    });
    
    recapHTML += `</tbody></table></div>`;
    monthlyRecapDiv.innerHTML = recapHTML;


    // 2. Render Chart
    if (chartInstance) {
        chartInstance.destroy(); // Hancurkan instance lama sebelum membuat yang baru
    }
    
    if (sortedMonths.length > 0) {
        monthlyChartCanvas.style.display = 'block';
        chartInstance = new Chart(monthlyChartCanvas, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Pengeluaran Bulanan (Rp)',
                    data: chartData,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)', // Merah
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Memungkinkan canvas untuk di-resize lebih baik
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'Rp ' + value.toLocaleString('id-ID');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Total Pengeluaran per Bulan (Bar Chart)'
                    }
                }
            }
        });
    } else {
        // Sembunyikan chart jika tidak ada data
        monthlyChartCanvas.style.display = 'none';
    }
}
window.renderChartsAndSummary = renderChartsAndSummary; // Jadikan global

// ------------------------------------
// FUNGSI PENGGANTI PROMPT/CONFIRM (Untuk Lingkungan Canvas)
// ------------------------------------

// Fungsi 4C: UPDATE (Mengedit Pengeluaran) - Diubah untuk konsol
function handleEditClick(docId, oldAmount, oldCategory, oldDescription) {
    if (!db) return console.error("[AUTH ERROR] DB tidak terinisialisasi.");
    console.log("--- EDIT TRANSAKSI ---");
    console.log(`ID Dokumen: ${docId}`);
    console.log(`Data Lama: Jumlah: ${oldAmount}, Kategori: ${oldCategory}, Deskripsi: ${oldDescription}`);
    console.log("Silakan panggil fungsi 'manualEdit' di konsol untuk mengupdate:");
    console.log(`Contoh: manualEdit('${docId}', 50000, 'Baru', 'Deskripsi Baru')`);

    // Fungsi bantuan manual untuk debugging/pengujian
    window.manualEdit = async (id, newAmount, newCategory, newDescription) => {
        if (!currentUserId) return console.error("Tidak ada pengguna yang terautentikasi.");
        if (!db) return console.error("Layanan database (db) tidak tersedia.");
        
        const collectionPath = `/artifacts/${appId}/users/${currentUserId}/expenses`;
        const expenseDocRef = db.collection(collectionPath).doc(id);

        if (newAmount && newCategory && newDescription) {
            try {
                await expenseDocRef.update({
                    amount: parseInt(newAmount), 
                    description: newDescription,
                    category: newCategory
                });
                console.log(`[SUKSES MANUAL] Transaksi ${id} berhasil diupdate.`);
            } catch (error) {
                console.error("[Gagal MANUAL] Error saat mengupdate dokumen: ", error);
            }
        } else {
            console.error("[Gagal MANUAL] Semua kolom (jumlah, kategori, deskripsi) harus diisi!");
        }
    };

}

// Fungsi 4D: DELETE (Menghapus Pengeluaran) - Diubah untuk konsol
function handleDeleteClick(docId) {
    if (!db) return console.error("[AUTH ERROR] DB tidak terinisialisasi.");
    console.log("--- HAPUS TRANSAKSI ---");
    console.log(`ID Dokumen: ${docId}`);
    console.log("Untuk menghapus, silakan panggil fungsi 'manualDelete' di konsol:");
    console.log(`Contoh: manualDelete('${docId}')`);

    // Fungsi bantuan manual untuk debugging/pengujian
    window.manualDelete = async (id) => {
        if (!currentUserId) return console.error("Tidak ada pengguna yang terautentikasi.");
        if (!db) return console.error("Layanan database (db) tidak tersedia.");
        
        const collectionPath = `/artifacts/${appId}/users/${currentUserId}/expenses`;
        const expenseDocRef = db.collection(collectionPath).doc(id);

        try {
            await expenseDocRef.delete();
            console.log(`[SUKSES MANUAL] Transaksi ${id} berhasil dihapus.`);
        } catch (error) {
            console.error("[Gagal MANUAL] Error saat menghapus dokumen: ", error);
        }
    };
}

// Membuat fungsi handler baru tersedia secara global
window.handleEditClick = handleEditClick;
window.handleDeleteClick = handleDeleteClick;
</script>
</body>
</html>