<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengeluaran Mudah - Firestore</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script> 
    <style>
        /* Custom Styles for Aesthetics and Responsiveness */
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; }
        h1 { color: #1e3a8a; border-bottom: 2px solid #bfdbfe; padding-bottom: 5px; }
        
        /* Expense Item Style */
        .expense-item { 
            border-bottom: 1px solid #e5e7eb; 
            padding: 1rem 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap; 
        }
        .expense-item > div {
            padding: 4px 0;
        }
        .amount { 
            font-weight: bold; 
            color: #ef4444; /* Red color for expenses */
            font-size: 1.1em;
            text-align: right;
        }
        .auth-card, .app-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        /* Custom alert replacement */
        .info-message {
            background-color: #fef3c7;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #fde68a;
        }
        /* Style for Monthly Recap Table */
        #monthly-recap table th:last-child {
            width: 1%; 
        }
    </style>
    
    <!-- FIREBASE MODULAR SDK IMPORTS (v11) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Memasang fungsi-fungsi penting ke window agar dapat diakses oleh kode non-module (seperti event onclick)
        window.firebaseModular = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, serverTimestamp, setLogLevel
        };
    </script> 
</head>
<body class="bg-gray-50 p-4">

<div class="container">
    <h1 class="text-3xl font-bold mb-6 text-center">üí∞ Catat Pengeluaran Harian</h1>

    <!-- SYSTEM STATUS SECTION -->
    <div id="status-alert" class="hidden p-3 mb-4 rounded-lg text-sm font-medium" role="alert"></div>

    <!-- SECTION 1: USER START -->
    <div id="auth-section" class="auth-card">
        <h2 class="text-xl font-semibold mb-4 text-blue-700">Mulai Catat Pengeluaran</h2>
        <p class="text-sm text-gray-600 mb-4">Aplikasi ini menggunakan otentikasi anonim untuk menyimpan data secara aman di cloud Anda.</p>
        
        <!-- User Name Input -->
        <input type="text" id="user-name-input" placeholder="Masukkan Nama Anda (Contoh: Budi)" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        
        <div class="flex">
            <!-- Panggil startAppAsUser saat tombol diklik -->
            <button id="start-button" onclick="startAppAsUser()" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-150">Mulai & Akses Data Cloud</button>
        </div>
        <div id="auth-error" class="mt-4 text-red-600 text-sm font-medium"></div>
    </div>
    
    <!-- SECTION 2: MAIN APPLICATION (Hidden before start) -->
    <div id="main-app" class="app-card" style="display: none;">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-700">Halo, <span id="user-display-name" class="font-bold text-blue-700">Pengguna</span>!</h3>
            <button onclick="signOut()" class="p-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold text-sm rounded-lg transition duration-150">Keluar</button>
        </div>
        
        <!-- Expense Form -->
        <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">üìù Catat Pengeluaran</h2>
        <form id="expense-form" class="space-y-3">
            <input type="number" id="amount" placeholder="Jumlah (contoh: 50000)" required class="w-full p-3 border border-gray-300 rounded-lg">
            <input type="text" id="description" placeholder="Deskripsi (contoh: Kopi dan Roti)" required class="w-full p-3 border border-gray-300 rounded-lg">
            <select id="category" required class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                <option value="" disabled selected>Pilih Kategori</option>
                <option value="Makanan">Makanan</option>
                <option value="Transportasi">Transportasi</option>
                <option value="Belanja">Belanja</option>
                <option value="Hiburan">Hiburan</option>
                <option value="Lainnya">Lainnya</option>
            </select>
            <button type="submit" class="w-full p-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-150">Tambah Pengeluaran</button>
        </form>
        
        <hr class="my-6">
        
        <!-- Summary & Global Export -->
        <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">üìä Ringkasan & Ekspor</h2>
        <p class="text-gray-700 text-lg mb-4">Total Pengeluaran: <span id="total-amount" class="font-bold text-red-600 ml-2">Rp 0</span></p>

        <div class="flex flex-wrap gap-2 justify-start mb-4">
            <!-- Global Raw Data Export Button -->
            <button onclick="exportRawDataToCsv()" class="p-2 text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-150 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Export Semua Data Mentah
            </button>
            <!-- Global Monthly Recap Export Button -->
            <button onclick="exportMonthlyRecapToCsv()" class="p-2 text-xs bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-150 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Export Semua Rekap Bulanan
            </button>
        </div>

        <hr class="my-6">

        <!-- Monthly Recap and Chart Section -->
        <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">üìà Grafik Pengeluaran Bulanan</h2>
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <canvas id="monthlyChart"></canvas>
        </div>

        <hr class="my-6">
        
        <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">üìÖ Rekap Pengeluaran per Bulan</h2>
        <div id="monthly-recap" class="mt-4">
            <!-- Monthly recap table will be loaded here -->
            <p class="text-gray-500">Memuat data rekap...</p>
        </div>
        
        <hr class="my-6">
        
        <!-- Transaction History -->
        <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">üìú Riwayat Transaksi</h2>
        <div class="info-message">
            Untuk **Edit** atau **Hapus**, tombol akan menampilkan instruksi di *Console* (F12) karena batasan keamanan di lingkungan ini. Anda perlu mengetik perintah `manualEdit()` atau `manualDelete()` di sana.
        </div>
        <div id="expense-list" class="mt-4">
            <!-- Data will be loaded here by script.js -->
        </div>
    </div>
</div>
    
<script>
// ------------------------------------
// SECTION 1: CONFIGURATION, INITIALIZATION, AND GLOBAL SCOPE
// ------------------------------------
let app, db, auth;
let currentUserId = null;
let currentUserName = null; 
let allExpenseData = []; 
let chartInstance = null; 
let isFirebaseInitialized = false; 

// DOM Variables
let userNameInput, startButton, authError, authSection, mainApp, userDisplayNameSpan;
let expenseForm, amountInput, descriptionInput, categoryInput, expenseList, totalAmountSpan;
let monthlyChartCanvas, monthlyRecapDiv, statusAlertDiv;

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Ambil konfigurasi dari variabel global lingkungan.
let firebaseConfig = {};

// ------------------------------------
// THE ENTIRE APPLICATION LOGIC RUNS AFTER THE DOM IS READY
// ------------------------------------
window.onload = async function() {
    // 1. DOM Elements
    userNameInput = document.getElementById('user-name-input');
    startButton = document.getElementById('start-button');
    authError = document.getElementById('auth-error');
    authSection = document.getElementById('auth-section');
    mainApp = document.getElementById('main-app');
    userDisplayNameSpan = document.getElementById('user-display-name');
    expenseForm = document.getElementById('expense-form');
    amountInput = document.getElementById('amount');
    descriptionInput = document.getElementById('description');
    categoryInput = document.getElementById('category');
    expenseList = document.getElementById('expense-list');
    totalAmountSpan = document.getElementById('total-amount');
    monthlyChartCanvas = document.getElementById('monthlyChart');
    monthlyRecapDiv = document.getElementById('monthly-recap');
    statusAlertDiv = document.getElementById('status-alert');


    // 2. ROBUST FIREBASE CONFIGURATION CHECK AND INITIALIZATION
    try {
        if (!window.firebaseModular) {
            throw new Error("Impor modular Firebase gagal. Pastikan CDN link diakses dengan benar.");
        }
        
        // Coba parsing konfigurasi yang disuntikkan secara global
        const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        
        if (configString.trim() !== '' && configString.trim() !== '{}') {
            try {
                firebaseConfig = JSON.parse(configString);
            } catch (jsonError) {
                console.error("[FATAL ERROR - CONFIG] Gagal Parsing JSON Konfigurasi:", configString, jsonError);
                throw new Error(`Gagal mem-parsing string konfigurasi Firebase (bukan JSON valid).`);
            }
        }
        
        // VALIDASI KRITIS: Cek Project ID
        if (!firebaseConfig || !firebaseConfig.projectId) {
            console.error("[FATAL ERROR - CONFIG] Konfigurasi yang diparsing (error expected):", firebaseConfig);
            // This is the source of the persistent error, thrown only if projectId is missing.
            throw new Error(`"projectId" not provided in firebase.initializeApp. Ini menunjukkan kegagalan dalam pengambilan konfigurasi global '__firebase_config' atau nilainya kosong.`);
        }
        
        console.log("[DEBUG CONFIG] Konfigurasi Firebase berhasil dimuat untuk Project ID:", firebaseConfig.projectId);

        // Inisialisasi Aplikasi Firebase
        app = window.firebaseModular.initializeApp(firebaseConfig);
        db = window.firebaseModular.getFirestore(app);
        auth = window.firebaseModular.getAuth(app);
        window.firebaseModular.setLogLevel('debug');
        isFirebaseInitialized = true;

        // Inisialisasi Otentikasi
        await initializeAuth(); 
        
    } catch (e) {
        console.error(`[FATAL ERROR] Gagal menginisialisasi Firebase: ${e.message}`, e);
        statusAlertDiv.classList.remove('hidden');
        statusAlertDiv.classList.add('bg-red-100', 'text-red-800');
        statusAlertDiv.innerHTML = `‚ùå **Kesalahan Fatal:** Gagal menyambung ke database. Cek konsol (F12) untuk detail error: **${e.message.split('.')[0]}**.`;
        return; 
    }
    
    // 3. START AUTH LISTENER
    setupAuthListener();
};


/**
 * Fungsi untuk menginisialisasi Otentikasi Awal
 * Digunakan untuk menangani __initial_auth_token
 */
async function initializeAuth() {
    if (!auth) {
        console.error("[DEBUG AUTH] initializeAuth dipanggil tetapi objek auth belum siap.");
        return;
    }

    // Menggunakan nama variabel yang benar sesuai instruksi
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
    
    try {
        if (auth.currentUser) {
            console.log("[DEBUG AUTH] Pengguna sudah terautentikasi.");
            return;
        }

        if (initialAuthToken) {
            // Menggunakan __initial_auth_token jika ada
            await window.firebaseModular.signInWithCustomToken(auth, initialAuthToken);
            console.log("[DEBUG AUTH] Custom Token Sign-in berhasil.");
        } else {
            // Gunakan Anonymous sign-in jika token tidak ada
            await window.firebaseModular.signInAnonymously(auth);
            console.log("[DEBUG AUTH] Anonymous Sign-in berhasil.");
        }
    } catch (error) {
        console.error("Gagal melakukan Sign-in Awal:", error);
        authError.textContent = `Gagal inisialisasi otentikasi: ${error.message}`;
    }
}


// ------------------------------------
// SECTION 2: AUTHENTICATION & APPLICATION SETUP FUNCTIONS
// ------------------------------------

function signOut() {
    if (auth) {
        auth.signOut();
    }
    // Clear local session data
    sessionStorage.removeItem('currentUserName');
    allExpenseData = []; // Clear global data
    
    // Clear display upon logout
    if (expenseList && totalAmountSpan) {
        expenseList.innerHTML = '';
        totalAmountSpan.textContent = `Rp 0`;
        if (chartInstance) chartInstance.destroy();
        if (monthlyRecapDiv) monthlyRecapDiv.innerHTML = '<p class="text-gray-500">Memuat data rekap...</p>';
    }
    
    // Re-show auth section
    authSection.style.display = 'block';
    mainApp.style.display = 'none';
    userNameInput.value = '';

    console.log("[DEBUG AUTH] User signed out.");
}
window.signOut = signOut;


async function startAppAsUser() {
    const name = userNameInput.value.trim();
    if (!name) {
        authError.textContent = 'Nama Pengguna harus diisi untuk memulai.';
        return;
    }

    currentUserName = name;
    sessionStorage.setItem('currentUserName', name);
    authError.textContent = '';
    
    // Pastikan Auth tersedia
    if (!auth || !isFirebaseInitialized) {
        authError.textContent = 'Layanan Firebase belum siap. Tunggu sebentar atau refresh.';
        return console.error("[DEBUG AUTH] Tombol diklik saat Firebase belum siap. Cek error konfigurasi di atas.");
    }

    // Jika Auth sudah selesai, langsung masuk
    if (auth.currentUser) {
        handleAuthSuccess(auth.currentUser);
    } else {
        // Jika belum selesai (race condition), coba panggil initializeAuth lagi
        await initializeAuth(); 
        console.log("[DEBUG AUTH] Auth sedang dalam proses. Menunggu onAuthStateChanged...");
        statusAlertDiv.classList.remove('hidden');
        statusAlertDiv.classList.add('bg-blue-100', 'text-blue-800');
        statusAlertDiv.innerHTML = '‚è≥ **Memproses Login:** Sedang menunggu koneksi aman ke Cloud...';
    }
}
window.startAppAsUser = startAppAsUser;


function handleAuthSuccess(user) {
    // Sembunyikan pesan status loading/error jika ada
    statusAlertDiv.classList.add('hidden');
    
    currentUserId = user.uid;
    console.log(`[DEBUG AUTH] Status: LOGGED IN. UID: ${currentUserId}`);

    authSection.style.display = 'none';
    mainApp.style.display = 'block';
    
    // Ambil nama dari sessionStorage, jika ada
    const storedName = sessionStorage.getItem('currentUserName');
    currentUserName = storedName || 'Pengguna Anonim'; 
    userDisplayNameSpan.textContent = currentUserName; 
    
    setupExpenseFormListener();
    loadExpenses();
}

function setupAuthListener() {
    if (!isFirebaseInitialized || !auth) return;
    
    window.firebaseModular.onAuthStateChanged(auth, (user) => {
        currentUserName = sessionStorage.getItem('currentUserName');
        
        if (user) {
            // User terautentikasi. Lanjutkan ke aplikasi utama jika nama sudah diisi.
            if (currentUserName) {
                handleAuthSuccess(user);
            } else {
                // User terotentikasi, tapi belum mengisi nama di UI. Tetap di Auth screen.
                authSection.style.display = 'block';
                mainApp.style.display = 'none';
                currentUserId = user.uid; 
            }
        } else {
            // User logout atau belum login
            currentUserId = null;
            currentUserName = null;
            allExpenseData = [];
            authSection.style.display = 'block';
            mainApp.style.display = 'none';
            userNameInput.value = '';
        }
    });
}


// ------------------------------------
// SECTION 3: EXPENSE FUNCTIONS (CRUD & RENDER)
// ------------------------------------

// Helper to Render the entire UI
function renderUI(data) {
    allExpenseData = data; // Update global data
    renderExpenseList(data);
    renderChartsAndSummary(data);
}

// Helper to Render the Transaction List
function renderExpenseList(data) {
    expenseList.innerHTML = '';
    let total = 0;
    
    if (data.length === 0) {
        expenseList.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada transaksi yang dicatat.</p>';
    }
    
    data.forEach(item => {
        const itemAmount = typeof item.amount === 'number' ? item.amount : 0;
        total += itemAmount;
        const docId = item.id; 
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'expense-item';
        
        // --- ADD USER NAME DISPLAY ---
        const userNameDisplay = item.userName ? `<span class="text-xs font-semibold text-indigo-600 mr-2">[${item.userName}]</span>` : '';

        itemDiv.innerHTML = `
            <div style="flex-grow: 1; max-width: 70%; min-width: 200px;">
                ${userNameDisplay}
                <strong class="text-gray-900">${item.description}</strong> 
                <span class="text-sm text-gray-500">(${item.category}) - ${item.date}</span>
            </div>
            <div class="amount flex-none mr-4">Rp ${itemAmount.toLocaleString('id-ID')}</div>
            <div class="flex space-x-2 flex-none mt-2 sm:mt-0">
                <button onclick="window.handleEditClick('${docId}', ${itemAmount}, '${item.category}', '${item.description}')" 
                        class="p-2 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition duration-150">
                    Edit
                </button>
                <button onclick="window.handleDeleteClick('${docId}')" 
                        class="p-2 bg-red-500 hover:bg-red-600 text-white text-xs rounded transition duration-150">
                    Hapus
                </button>
            </div>
        `;
        
        expenseList.appendChild(itemDiv);
    });
    
    totalAmountSpan.textContent = `Rp ${total.toLocaleString('id-ID')}`;
}


// Function 3A: CREATE (Add Expense)
function setupExpenseFormListener() {
    if (expenseForm) {
        expenseForm.removeEventListener('submit', handleExpenseSubmit); 
        expenseForm.addEventListener('submit', handleExpenseSubmit); 
    }
}

async function handleExpenseSubmit(e) {
    e.preventDefault();

    if (!currentUserId || !currentUserName || !db) {
        authError.textContent = 'Layanan tidak tersedia. Silakan masuk (login) terlebih dahulu dan isi Nama Pengguna.';
        return console.error("[DEBUG DATA] Gagal menambahkan. Tidak ada pengguna terotentikasi atau nama/db.");
    }

    const amount = parseInt(amountInput.value);
    const category = categoryInput.value;
    const description = descriptionInput.value;
    const date = new Date().toISOString().split('T')[0];
    const timestamp = window.firebaseModular.serverTimestamp(); 

    const newExpense = {
        amount: amount,
        category: category,
        description: description,
        date: date,
        timestamp: timestamp, 
        userId: currentUserId,
        userName: currentUserName 
    };

    if (amount > 0 && category && description) {
        // Path collection: /artifacts/{appId}/users/{userId}/expenses
        const collectionRef = window.firebaseModular.collection(db, `/artifacts/${appId}/users/${currentUserId}/expenses`);
        try {
            await window.firebaseModular.addDoc(collectionRef, newExpense); 
            console.log("[DEBUG DATA] Transaksi berhasil ditambahkan ke Firestore!");
        } catch (error) {
            console.error("[DEBUG DATA] Error saat menambahkan dokumen: ", error);
            authError.textContent = 'Gagal menambah transaksi ke Cloud. Cek konsol.';
        }

        expenseForm.reset(); 
    } else {
        console.log("[DEBUG DATA] Peringatan: Pastikan semua kolom diisi dengan benar.");
    }
}


// Function 3B: READ (Load and Display Expenses)
function loadExpenses() {
    if (!currentUserId || !db) {
        return console.log("[DEBUG DATA] loadExpenses dihentikan. Prasyarat tidak terpenuhi.");
    }
    
    // Path collection: /artifacts/{appId}/users/{userId}/expenses
    const collectionRef = window.firebaseModular.collection(db, `/artifacts/${appId}/users/${currentUserId}/expenses`);
    const q = window.firebaseModular.query(collectionRef, window.firebaseModular.orderBy('timestamp', 'desc'));
    
    // Listen for real-time changes
    window.firebaseModular.onSnapshot(q, (snapshot) => {
            console.log(`[DEBUG DATA] Snapshot diterima. Jumlah dokumen: ${snapshot.size}`);
            const data = [];
            snapshot.forEach(doc => {
                const item = doc.data();
                // Konversi Timestamp ke milidetik jika ada
                const itemTimestamp = item.timestamp && typeof item.timestamp.toDate === 'function' ? item.timestamp.toDate().getTime() : Date.now(); 
                data.push({ 
                    ...item, 
                    id: doc.id,
                    timestamp: itemTimestamp,
                });
            });
            // Sorting di client side sebagai fallback/penyempurna
            data.sort((a, b) => b.timestamp - a.timestamp); 
            renderUI(data); // Panggil helper untuk render
        }, error => {
            console.error("[DEBUG DATA] Error saat membaca data (onSnapshot): ", error);
            // Show error in UI
            statusAlertDiv.classList.remove('hidden');
            statusAlertDiv.classList.add('bg-red-100', 'text-red-800');
            statusAlertDiv.innerHTML = `‚ùå **Kesalahan Data:** Gagal memuat data dari Cloud Firestore. Cek konsol untuk detail teknis.`;
        });
}


// ------------------------------------
// SECTION 4: VISUALIZATION AND MONTHLY RECAP
// ------------------------------------
// (Fungsi-fungsi ini tidak diubah)

function renderChartsAndSummary(data) {
    if (!monthlyChartCanvas || !monthlyRecapDiv) return;

    // 1. Aggregate Data per Month
    const monthlySummary = data.reduce((acc, expense) => {
        const expenseDate = expense.date;
        if (typeof expenseDate === 'string' && expenseDate.length >= 7) {
            const yearMonth = expenseDate.substring(0, 7); 
            acc[yearMonth] = (acc[yearMonth] || 0) + expense.amount;
        }
        return acc;
    }, {});
    
    // Convert object to sorted array (latest on top)
    const sortedMonths = Object.keys(monthlySummary).sort().reverse();
    
    const chartLabels = [];
    const chartData = [];
    
    // Prepare HTML for the recap table
    let recapHTML = `
        <div class="overflow-x-auto rounded-lg shadow-md">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-100">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider">Bulan</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-blue-800 uppercase tracking-wider">Total Pengeluaran</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-blue-800 uppercase tracking-wider">Export</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;

    if (sortedMonths.length === 0) {
        recapHTML = '<p class="text-gray-500 text-center py-4">Belum ada data untuk membuat rekap bulanan.</p>';
        monthlyRecapDiv.innerHTML = recapHTML;
    } else {
        sortedMonths.forEach(ym => {
            const amount = monthlySummary[ym];
            // Format month: e.g., "December 2025"
            const displayMonth = new Date(ym + '-01').toLocaleString('id-ID', { year: 'numeric', month: 'long' });
            
            // Data for Chart (order needs to be reversed for chronological chart)
            chartLabels.unshift(displayMonth);
            chartData.unshift(amount);
            
            // Data for Recap Table
            recapHTML += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${displayMonth}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600 font-bold">Rp ${amount.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button onclick="exportSpecificMonthToCsv('${ym}', '${displayMonth}')" 
                                class="p-1.5 bg-green-500 hover:bg-green-600 text-white text-xs rounded transition duration-150 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        recapHTML += `</tbody></table></div>`;
        monthlyRecapDiv.innerHTML = recapHTML;
    }


    // 2. Render Chart
    if (chartInstance) {
        chartInstance.destroy(); // Destroy old instance
    }
    
    if (sortedMonths.length > 0) {
        monthlyChartCanvas.style.display = 'block';
        // Set fixed height for chart to prevent CLS
        monthlyChartCanvas.style.height = '300px'; 

        const ctx = monthlyChartCanvas.getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Pengeluaran Bulanan (Rp)',
                    data: chartData,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'Rp ' + value.toLocaleString('id-ID');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Total Pengeluaran per Bulan (Bar Chart)'
                    }
                }
            }
        });
    } else {
        // Hide chart if no data
        monthlyChartCanvas.style.display = 'none';
    }
}
window.renderChartsAndSummary = renderChartsAndSummary;


// ------------------------------------
// SECTION 5: CSV EXPORT FUNCTIONS
// ------------------------------------

// Utility function to create CSV rows from an array of columns
const processRowToCsv = (row) => row.map(cell => {
    if (typeof cell === 'string') {
        // Escape double quotes and wrap in double quotes
        return `"${cell.replace(/"/g, '""')}"`;
    }
    return cell;
}).join(',');

// Utility function to download CSV content
function downloadCsv(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url); // Clean up the URL object
}


/**
 * 5A. Export Global Raw Data (all transactions)
 */
function exportRawDataToCsv() {
    if (allExpenseData.length === 0) {
        console.log("Tidak ada data pengeluaran yang tercatat untuk diekspor.");
        return;
    }
    
    const headers = ["ID Transaksi", "Jumlah", "Deskripsi", "Kategori", "Tanggal", "Nama Pengguna", "Timestamp (ms)"];
    
    const rows = allExpenseData.map(item => [
        item.id || '',
        item.amount || 0,
        item.description || '',
        item.category || '',
        item.date || '',
        item.userName || '',
        item.timestamp || '' // Include raw timestamp
    ]);

    const csvContent = [
        processRowToCsv(headers),
        ...rows.map(processRowToCsv)
    ].join('\n');
    
    const currentDate = new Date().toISOString().split('T')[0];
    downloadCsv(csvContent, `pengeluaran_mentah_semua_${currentDate}.csv`);
    
    console.log(`[EXPORT] Berhasil mengunduh Semua Data Mentah (${allExpenseData.length} baris) ke CSV.`);
}
window.exportRawDataToCsv = exportRawDataToCsv;


/**
 * 5B. Export Global Monthly Recap (total summary)
 */
function exportMonthlyRecapToCsv() {
    if (allExpenseData.length === 0) {
        console.log("Tidak ada data pengeluaran yang tercatat untuk membuat rekap.");
        return;
    }
    
    // Calculate Aggregated Data per Month
    const monthlySummary = allExpenseData.reduce((acc, expense) => {
        const expenseDate = expense.date;
        if (typeof expenseDate === 'string' && expenseDate.length >= 7) {
            const yearMonth = expenseDate.substring(0, 7); 
            acc[yearMonth] = (acc[yearMonth] || 0) + expense.amount;
        }
        return acc;
    }, {});

    const sortedMonths = Object.keys(monthlySummary).sort().reverse();
    
    const headers = ["Bulan", "Total Pengeluaran (Rp)"];
    
    const rows = sortedMonths.map(ym => {
        const amount = monthlySummary[ym];
        const displayMonth = new Date(ym + '-01').toLocaleString('id-ID', { year: 'numeric', month: 'long' });
        
        return [
            displayMonth, 
            amount 
        ];
    });

    const csvContent = [
        processRowToCsv(headers),
        ...rows.map(processRowToCsv)
    ].join('\n');
    
    const currentDate = new Date().toISOString().split('T')[0];
    downloadCsv(csvContent, `rekap_bulanan_semua_${currentDate}.csv`);
    
    console.log(`[EXPORT] Berhasil mengunduh Rekap Bulanan (${sortedMonths.length} bulan) ke CSV.`);
}
window.exportMonthlyRecapToCsv = exportMonthlyRecapToCsv;


/**
 * 5C. Export Specific Raw Data Per Month
 * @param {string} yearMonth - Format 'YYYY-MM' (e.g., '2025-11')
 * @param {string} displayMonth - Formatted month name (e.g., 'November 2025')
 */
function exportSpecificMonthToCsv(yearMonth, displayMonth) {
    
    // 1. Filter data only for the requested month
    const filteredData = allExpenseData.filter(item => 
        item.date && item.date.startsWith(yearMonth)
    );

    if (filteredData.length === 0) {
        console.log(`Tidak ada data transaksi yang tercatat untuk bulan ${displayMonth}.`);
        return;
    }

    // 2. Define CSV Headers (same as raw data)
    const headers = ["ID Transaksi", "Jumlah", "Deskripsi", "Kategori", "Tanggal", "Nama Pengguna", "Timestamp (ms)"];
    
    // 3. Format Filtered Data Rows
    const rows = filteredData.map(item => [
        item.id || '',
        item.amount || 0,
        item.description || '',
        item.category || '',
        item.date || '',
        item.userName || '',
        item.timestamp || ''
    ]);

    // 4. Combine and Download
    const csvContent = [
        processRowToCsv(headers),
        ...rows.map(processRowToCsv)
    ].join('\n');
    
    const filename = `pengeluaran_${yearMonth}.csv`;
    downloadCsv(csvContent, filename);
    
    console.log(`[EXPORT] Berhasil mengunduh Data Mentah untuk ${displayMonth} (${filteredData.length} baris) ke CSV.`);
}
window.exportSpecificMonthToCsv = exportSpecificMonthToCsv;


// ------------------------------------
// SECTION 6: PROMPT/CONFIRM REPLACEMENT FUNCTIONS (FOR CANVAS ENVIRONMENT)
// ------------------------------------

// Function 6A: UPDATE (Edit Expense) - Modified for console
function handleEditClick(docId, oldAmount, oldCategory, oldDescription) {
    console.log("--- EDIT TRANSACTION ---");
    console.log(`Document ID: ${docId}`);
    console.log(`Old Data: Jumlah: ${oldAmount}, Kategori: ${oldCategory}, Deskripsi: ${oldDescription}`);
    console.log("Silakan panggil fungsi 'manualEdit' di konsol untuk memperbarui:");
    console.log(`Contoh: manualEdit('${docId}', 50000, 'Transportasi', 'Bensin Baru')`);

    // Manual helper function for debugging/testing
    window.manualEdit = async (id, newAmount, newCategory, newDescription) => {
        if (!currentUserId || !db) return console.error("Tidak ada pengguna yang terotentikasi atau koneksi database.");
        
        // Path document: /artifacts/{appId}/users/{userId}/expenses/{docId}
        const docRef = window.firebaseModular.doc(db, `/artifacts/${appId}/users/${currentUserId}/expenses`, id);
        
        const updatePayload = {
            amount: parseInt(newAmount), 
            description: newDescription,
            category: newCategory,
            date: new Date().toISOString().split('T')[0], 
        };

        try {
            await window.firebaseModular.updateDoc(docRef, updatePayload);
            console.log(`[DEBUG DATA] Dokumen ID ${id} berhasil diperbarui.`);
        } catch (error) {
            console.error(`[DEBUG DATA] Gagal memperbarui dokumen ID ${id}: `, error);
        }
    };
}
window.handleEditClick = handleEditClick;


// Function 6B: DELETE (Delete Expense) - Modified for console
function handleDeleteClick(docId) {
    console.log("--- DELETE TRANSACTION ---");
    console.log(`Document ID: ${docId}`);
    console.log("PERINGATAN: Penghapusan bersifat permanen.");
    console.log("Silakan panggil fungsi 'manualDelete' di konsol untuk konfirmasi penghapusan:");
    console.log(`Contoh: manualDelete('${docId}')`);

    // Manual helper function for debugging/testing
    window.manualDelete = async (id) => {
        if (!currentUserId || !db) return console.error("Tidak ada pengguna yang terotentikasi atau koneksi database.");
        
        // Path document: /artifacts/{appId}/users/{userId}/expenses/{docId}
        const docRef = window.firebaseModular.doc(db, `/artifacts/${appId}/users/${currentUserId}/expenses`, id);
        
        try {
            await window.firebaseModular.deleteDoc(docRef);
            console.log(`[DEBUG DATA] Dokumen ID ${id} berhasil dihapus.`);
        } catch (error) {
            console.error(`[DEBUG DATA] Gagal menghapus dokumen ID ${id}: `, error);
        }
    };
}
window.handleDeleteClick = handleDeleteClick;
</script>
</body>
</html>